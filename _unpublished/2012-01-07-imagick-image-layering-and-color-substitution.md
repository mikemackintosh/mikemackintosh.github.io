---
layout: post
permalink: /?p=392
title: "Imagick Image Layering and Color Substitution"
category: ["uncategorized"]
tags: 
---
[php] include(APPPATH.'controllers/angry\_imager.php'); $ai = new Angry\_Imager(); if($ai->create\_item\_images($\_FILES['picture']['tmp\_name'],$\_FILES['picture']['name'])){ $image = $ai->image\_name; } [/php] [php] class Angry\_Imager { var $background\_image = '/var/www/vhosts/optical-academy.com/dev/images/products/product-box.png'; var $item\_image\_path = '/var/www/vhosts/optical-academy.com/dev/images/product-images/'; var $cat\_image\_path = '/var/www/vhosts/optical-academy.com/dev/images/categories/'; function create\_category\_image($input\_image, $cat\_name){ $original\_image = $input\_image; // the image to be patched over the final bg $large\_background = $this->background\_image; // the image to be patched over the final bg $temp\_name = '/tmp/'.md5(time().$original\_image ); $prep = new Imagick(); $prep->readImage($original\_image); $prep->height = $prep->getImageHeight(); $prep->width = $prep->getImageWidth(); if($prep->width >= $prep->height){ $width = 200; $height = ($prep->height \* $width)/$prep->width; $x\_offset = 12.5; $y\_offset = abs($height-200)/2; } else{ $height = 175; $width = ($prep->width \* $height)/$prep->width; $y\_offset = 12.5; $x\_offset = abs(225-$width)/2; } $prep->resizeImage($width,$height,Imagick::FILTER\_LANCZOS,1); $prep->writeImage($temp\_name); $first = new Imagick(); $first->newimage(225, 200, "rgba(0, 0, 0, 0)"); $first->readImage($temp\_name); $first->transparentPaintImage('#FFFFFF', 0.0,25,false); $first->setImageFormat( "png" ); $first->writeImage($temp\_name.'\_transparent' ); $background = new Imagick($large\_background ); //Second image is put on top of the first $background->compositeImage($first, $first->getImageCompose(), $x\_offset, $y\_offset); $background->setImageFormat( "png" ); $background->writeImage($this->cat\_image\_path.$cat\_name.'.png'); @unlink($temp\_name); @unlink($temp\_name.'\_transparent'); @chmod($this->cat\_image\_path.$cat\_name.'.png', 0775); $prep->destroy(); $background->destroy(); $first->destroy(); if(is\_file($this->cat\_image\_path.$cat\_name.'.png')){ $this->image\_name = $cat\_name; return true; } return false; } } [/php]

